---
import BaseLayout from '../layouts/BaseLayout.astro';
import PrayerTimes from '../components/PrayerTimes.astro';
import ImageCarousel from '../components/ImageCarousel.astro';
import VisitorInfo from '../components/VisitorInfo.astro';
import PatternOverlay from '../components/PatternOverlay.astro';
import { getCollection, type CollectionEntry } from 'astro:content';

const allEvents = await getCollection('events');
const now = new Date();
now.setHours(0, 0, 0, 0);

const upcomingEvents = allEvents
  .filter((event: CollectionEntry<'events'>) => new Date(event.data.date) >= now)
  .sort((a: CollectionEntry<'events'>, b: CollectionEntry<'events'>) => 
    new Date(a.data.date).getTime() - new Date(b.data.date).getTime()
  )
  .slice(0, 3);

function formatDate(date: Date): string {
  // Parse as local date to avoid timezone shift
  const dateStr = date.toISOString().split('T')[0];
  const [year, month, day] = dateStr.split('-').map(Number);
  const localDate = new Date(year, month - 1, day);
  return localDate.toLocaleDateString('en-US', {
    weekday: 'short',
    month: 'short',
    day: 'numeric',
  });
}

function getEventTypeStyles(type: string): { bg: string; text: string; accent: string } {
  const styles: Record<string, { bg: string; text: string; accent: string }> = {
    jummah: { bg: 'bg-mosque-800/10', text: 'text-mosque-800', accent: 'border-l-mosque-800' },
    lecture: { bg: 'bg-gold-400/10', text: 'text-gold-600', accent: 'border-l-gold-500' },
    class: { bg: 'bg-purple-100', text: 'text-purple-800', accent: 'border-l-purple-500' },
    community: { bg: 'bg-amber-100', text: 'text-amber-800', accent: 'border-l-amber-500' },
    other: { bg: 'bg-stone-100', text: 'text-stone-800', accent: 'border-l-stone-400' },
  };
  return styles[type] || styles.other;
}
---

<BaseLayout title="Welcome">
  <!-- Hero Section -->
  <section class="relative bg-cream-100 overflow-hidden">
    <!-- Pattern Overlay -->
    <PatternOverlay />

    <div class="relative z-10 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-20 sm:py-24 lg:py-32">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-12 lg:gap-10 items-start">
        <!-- Hero Content -->
        <div class="max-w-2xl lg:max-w-xl">
          <div class="inline-flex items-center px-3 py-1 rounded-full border border-gold-500/30 bg-gold-500/10 text-gold-600 text-sm font-medium mb-6">
            <span class="flex h-2 w-2 rounded-full bg-gold-500 mr-2 animate-pulse"></span>
            Welcome to Your Community
          </div>
          
          <h1 class="text-4xl sm:text-5xl lg:text-6xl font-bold font-serif tracking-tight text-mosque-800 mb-6 leading-[1.1]">
            As-Salaamu Alaikum
          </h1>
          
          <p class="text-lg sm:text-xl text-stone-600 leading-relaxed mb-10 max-w-lg">
            Welcome to Al-Bushra Mosque in Dedham, MA. A sanctuary for worship, a center for learning, and a home for our growing community.
          </p>
          
          <div class="flex flex-col sm:flex-row gap-4">
            <a
              href="/events"
              class="inline-flex items-center justify-center px-8 py-4 text-base font-semibold text-white bg-mosque-800 rounded-xl hover:bg-mosque-900 transition-all duration-200 shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-mosque-800 focus:ring-offset-2 focus:ring-offset-cream-100"
            >
              Upcoming Events
            </a>
            <a
              href="#visitor-info"
              class="inline-flex items-center justify-center px-8 py-4 text-base font-semibold text-mosque-800 border-2 border-mosque-800/20 bg-transparent rounded-xl hover:bg-mosque-800/5 hover:border-mosque-800/40 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-mosque-800 focus:ring-offset-2 focus:ring-offset-cream-100"
            >
              Visitor Info
            </a>
          </div>
        </div>

        <!-- Prayer Times Card -->
        <div class="w-full mx-auto lg:mx-0 lg:justify-self-center relative space-y-6 sm:space-y-8">
          <ImageCarousel />
          <div class="relative w-full">
            <PrayerTimes />
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Upcoming Events Section -->
  <section class="py-24 bg-white" aria-labelledby="events-heading">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="text-center max-w-3xl mx-auto mb-16">
        <h2 id="events-heading" class="text-3xl sm:text-4xl font-bold font-serif text-mosque-800 mb-6 tracking-tight">
          Upcoming Events
        </h2>
        <p class="text-lg text-stone-600 leading-relaxed">
          Join us for prayers, gatherings, and community programs.
        </p>
      </div>

      {upcomingEvents.length === 0 ? (
        <div class="text-center py-12 bg-cream-50 rounded-2xl border border-cream-200 max-w-2xl mx-auto">
          <h3 class="text-lg font-semibold text-mosque-800 mb-2">No upcoming events</h3>
          <p class="text-stone-600">Check back soon!</p>
        </div>
      ) : (
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8 lg:gap-10">
          {upcomingEvents.map((event: CollectionEntry<'events'>) => (
            <article class={`group p-6 bg-cream-50 rounded-2xl border border-stone-100 border-l-4 ${getEventTypeStyles(event.data.type).accent} hover:border-gold-500/30 hover:shadow-lg transition-all duration-300`}>
              <div class="flex items-center gap-2 text-sm text-stone-500 mb-3">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
                <time datetime={new Date(event.data.date).toISOString()}>
                  {formatDate(new Date(event.data.date))}
                </time>
                <span class="text-stone-300">â€¢</span>
                <span>{event.data.time}</span>
              </div>
              <h3 class="text-xl font-bold font-serif text-mosque-800 mb-2">{event.data.title}</h3>
              <p
                class="text-stone-600 text-sm leading-relaxed line-clamp-2"
                title={event.data.description}
                aria-label={event.data.description}
              >
                {event.data.description}
              </p>
            </article>
          ))}
        </div>
      )}

      <div class="text-center mt-12">
        <a
          href="/events"
          class="inline-flex items-center justify-center px-8 py-3 text-base font-semibold text-mosque-800 border-2 border-mosque-800/20 bg-transparent rounded-xl hover:bg-mosque-800/5 hover:border-mosque-800/40 transition-all duration-200"
        >
          View All Events
          <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
          </svg>
        </a>
      </div>
    </div>
  </section>

  <!-- Visitor Info Section -->
  <section id="visitor-info" class="py-16 sm:py-20 bg-cream-100">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="max-w-2xl mx-auto">
        <VisitorInfo />
      </div>
    </div>
  </section>

  <!-- Support Our Mission Section -->
  <section class="py-16 sm:py-20 bg-mosque-800">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
      <h2 class="text-3xl sm:text-4xl font-bold font-serif text-white mb-4">
        Support Our Mission
      </h2>
      <p class="text-lg text-cream-200 mb-8 max-w-2xl mx-auto">
        Help us maintain our sanctuary and serve the local community.
      </p>
      <a
        href="/donate"
        class="inline-flex items-center justify-center px-10 py-4 text-lg font-semibold text-mosque-800 bg-gold-400 rounded-xl hover:bg-gold-500 transition-all duration-200 shadow-lg hover:shadow-xl focus:outline-none focus:ring-2 focus:ring-gold-400 focus:ring-offset-2 focus:ring-offset-mosque-800"
      >
        Donate Now
      </a>
    </div>
  </section>
</BaseLayout>
