---
interface Props {
  prayerTimesJson: string;
}

const { prayerTimesJson } = Astro.props;
---

<div class="mb-6 p-4 bg-sky-50 rounded-lg border border-sky-100">
  <div class="flex items-center justify-between gap-4">
    <div>
      <p class="text-sm text-stone-600">Next Prayer</p>
      <p class="text-lg font-semibold text-sky-900" id="next-prayer-name">Loading...</p>
    </div>
    <div class="text-right">
      <p class="text-sm text-stone-600">Time Remaining</p>
      <p class="text-2xl font-bold text-sky-800 tabular-nums" id="countdown-timer">--:--:--</p>
    </div>
  </div>
</div>

<script define:vars={{ prayerTimesJson }}>
  const prayers = JSON.parse(prayerTimesJson);
  
  function parseTime(timeStr) {
    const [hours, minutes] = timeStr.split(':').map(Number);
    const now = new Date();
    return new Date(now.getFullYear(), now.getMonth(), now.getDate(), hours, minutes, 0);
  }
  
  function getNextPrayer() {
    const now = new Date();
    
    for (const prayer of prayers) {
      if (prayer.name === 'Sunrise') continue;
      const prayerTime = parseTime(prayer.time);
      if (prayerTime > now) {
        return { name: prayer.name, time: prayerTime };
      }
    }
    
    const fajr = prayers.find(p => p.name === 'Fajr');
    if (fajr) {
      const tomorrow = parseTime(fajr.time);
      tomorrow.setDate(tomorrow.getDate() + 1);
      return { name: 'Fajr', time: tomorrow };
    }
    
    return null;
  }
  
  function formatCountdown(ms) {
    if (ms <= 0) return '00:00:00';
    
    const totalSeconds = Math.floor(ms / 1000);
    const hours = Math.floor(totalSeconds / 3600);
    const minutes = Math.floor((totalSeconds % 3600) / 60);
    const seconds = totalSeconds % 60;
    
    return [hours, minutes, seconds]
      .map(n => String(n).padStart(2, '0'))
      .join(':');
  }
  
  function updateCountdown() {
    const nextPrayer = getNextPrayer();
    const nameEl = document.getElementById('next-prayer-name');
    const timerEl = document.getElementById('countdown-timer');
    
    if (!nextPrayer || !nameEl || !timerEl) return;
    
    nameEl.textContent = nextPrayer.name;
    const remaining = nextPrayer.time.getTime() - Date.now();
    timerEl.textContent = formatCountdown(remaining);
  }
  
  updateCountdown();
  setInterval(updateCountdown, 1000);
</script>
